{% load static %}

{% block map_digitizer %}

<script src="{% static 'js/ol.js' %}"></script>
<link rel="stylesheet" href="{% static 'css/ol.css' %}" type="text/css">

<script src="{% static 'js/jquery.min.js' %}"></script>
<script src="{% static 'js/jquery.easytabs.js' %}" type="text/javascript"></script>
<!--<script type="text/javascript" src="http://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>-->

<!-- style -->
<style>
    #map-and-tools {
        display: flex;
        flex-direction: row;
        gap: 10px;
    }
    #map {
        width: 100%; 
        height: 420px;
        border: lightgray 1px solid;
    }
    #tab-container {
        width: 60%;
        height: 400px;
    }
    #border-levels-table {
        width: 100%;
    }
    #digitize-tab, #names-tab {
        height: 380px;
        overflow: auto;
    }
</style>

<!-- Form -->
<section>
    <div class="content">
        <div>
            <div id="map-and-tools">

                <div id="map">
                </div>

                <div id="tab-container" class="tab-container">

                    <ul class='etabs'>
                        <li class='tab active'><a href="#digitize-tab">Digitize</a></li>
                        <li class='tab'><a href="#names-tab">Names</a></li>
                    </ul>

                    <div id="digitize-tab" class="box">

                        <div style="width:100%; text-align:right">
                            <span><button class="small">Save</button></span>
                        </div>

                        <h3>Border Lines</h3>
                        <table id="border-levels-table">
                            <thead>
                                <th>Level</th>
                                <th></th>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>

                        <div style="width:100%; text-align:center">
                            <span><button class="small" onclick="addNewLevel()">Add level</button></span>
                        </div>

                    </div>

                    <div id="names-tab" class="box">
                    </div>

                </div>

            </div>
            
            <br><br>

        </div>

    </div>
</section>

<!-- Some dynamic javascript functionality -->

<script>
    // tab init
	$(document).ready(function () { $('#tab-container').easytabs({animate:false}); });

    // https://stackoverflow.com/questions/63086424/openlayers-dynamic-image-sizes

    // image pixel projection
    const projection = new ol.proj.Projection({
        code: 'pixel-map',
        units: 'pixels',
        extent: [0, 0, 10000, 10000],
    });

    // map image layer
    var mapLayer = new ol.layer.Image({});
    function setImageSource (url) {
        // clear old source
        mapLayer.setSource();
        if (!url) {
            url = 'https://www.av.se/Static/images/placeholder.png';
        };
        // what to do on image load
        const img = document.createElement('img');
        img.onload = function() {
            // get image extent
            const extent = [0, 0, img.width, img.height];
            // set source
            mapLayer.setSource(
                new ol.source.ImageStatic({
                    url: url,
                    imageExtent: extent,
                }),
            );
            // zoom to image extent
            map.getView().fit(mapLayer.getSource().getImageExtent())
        };
        // begin loading image
        img.src = url;
    };
    url = "{{ source.url }}";
    setImageSource(url);

    // border layers
    var adm0Layer = new ol.layer.Vector({
        source: new ol.source.Vector(),
        style: new ol.style.Style({
            stroke: new ol.style.Stroke({
                width: 3
            })
        })
    });
    var adm1Layer = new ol.layer.Vector({
        source: new ol.source.Vector(),
        style: new ol.style.Style({
            stroke: new ol.style.Stroke({
                width: 2.5,
                lineDash: [10, 10] //or other combinations
            })
        })
    });
    var adm2Layer = new ol.layer.Vector({
        source: new ol.source.Vector(),
        style: new ol.style.Style({
            stroke: new ol.style.Stroke({
                width: 2,
                lineDash: [8, 8] //or other combinations
            })
        })
    });
    var adm3Layer = new ol.layer.Vector({
        source: new ol.source.Vector(),
        style: new ol.style.Style({
            stroke: new ol.style.Stroke({
                width: 1.5,
                lineDash: [6, 6] //or other combinations
            })
        })
    });
    var adm4Layer = new ol.layer.Vector({
        source: new ol.source.Vector(),
        style: new ol.style.Style({
            stroke: new ol.style.Stroke({
                width: 1,
                lineDash: [4, 4] //or other combinations
            })
        })
    });
    var adm5Layer = new ol.layer.Vector({
        source: new ol.source.Vector(),
        style: new ol.style.Style({
            stroke: new ol.style.Stroke({
                width: 0.5,
                lineDash: [2, 2] //or other combinations
            })
        })
    });

    //var labelLayer = new ol.layer.Vector({
    //    source: new ol.source.Vector(),
    //    //style: style,
    //});

    // map
    var borderLayers = [adm0Layer, adm1Layer, adm2Layer, adm3Layer, adm4Layer, adm5Layer];
    var layers = [mapLayer];
    for (lyr of borderLayers) {
        layers.push(lyr);
    };
    var map = new ol.Map({
        target: 'map',
        controls: ol.control.defaults().extend([new ol.control.FullScreen(),
                                                new ol.control.ScaleLine({units: 'metric'}),
                                                ]),
        layers: layers,
        view: new ol.View({
            projection,
            center: [0,0], //getCenter(extent),
            zoom: 2
        })
    });

    /////////////////////////////
    // drawing functionality

    let draw; // global so we can remove it later
    let modify;
    let snap;
    
    function enableDrawInteraction(lyr) {
        try {map.removeInteraction(snap)} catch {};
        try {map.removeInteraction(draw)} catch {};
        draw = new ol.interaction.Draw({
            source: lyr.getSource(),
            type: 'MultiLineString',
        });
        map.addInteraction(draw);
        snap = new ol.interaction.Snap({
            source: lyr.getSource()
        });
        map.addInteraction(snap);
    };

    function enableEditInteraction(lyr) {
        try {map.removeInteraction(snap)} catch {};
        try {map.removeInteraction(draw)} catch {};
        try {map.removeInteraction(modify)} catch {};
        modify = new ol.interaction.Modify({
            source: lyr.getSource()
        });
        map.addInteraction(modify);
        snap = new ol.interaction.Snap({
            source: lyr.getSource()
        });
        map.addInteraction(snap);
    };

    function addNewLevel() {
        newLevelRow();
    };

    function newLevelRow() {
        tbody = document.querySelector('#border-levels-table tbody');
        lvl = tbody.querySelectorAll('tr').length;

        tr = document.createElement('tr');
        tbody.appendChild(tr);

        td = document.createElement('td');
        tr.appendChild(td);
        td.innerHTML = '<span>ADM'+lvl+'</span>';

        td = document.createElement('td');
        td.style = "text-align:right";
        tr.appendChild(td);
        buttons = document.createElement('span');
        td.appendChild(buttons);
        
        addBut = '<button class="small" onclick="drawBorderLevel('+lvl+')">+</button>';
        //editIcon = "{% static 'mapDigitizer/images/edit.png' %}";
        editBut = '<button class="small" onclick="editBorderLevel('+lvl+')">Edit</button>';
        buttons.innerHTML = addBut + editBut;
        /*
        addBut = document.createElement('button');
        addBut.className = 'small';
        addBut.innerHTML = 'Draw';
        addBut.onClick = "enableDrawInteraction()";
        buttons.appendChild(addBut);
        */
    };

    function drawBorderLevel(lvl) {
        lyr = borderLayers[lvl];
        enableDrawInteraction(lyr);
    };

    function editBorderLevel(lvl) {
        lyr = borderLayers[lvl];
        enableEditInteraction(lyr);
    };

    addNewLevel();

</script>

{% endblock %}
